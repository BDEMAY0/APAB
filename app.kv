#:import MDScreen kivymd.uix.screen.MDScreen
#:import MDTopAppBar kivymd.uix.toolbar.MDTopAppBar
#:import MDFloatingActionButton kivymd.uix.button.MDFloatingActionButton
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDCheckbox kivymd.uix.selectioncontrol.MDCheckbox
#:import FadeTransition kivy.uix.screenmanager
#:import sm kivy.uix.screenmanager
#:import MDFileManager kivymd.uix.filemanager.MDFileManager

ScreenManagement:
    transition: sm.FadeTransition()
    Accueil:
        name: 'Accueil'
    PentestScreen:
        name: 'PentestScreen'
    Option:
        name: 'Option'
    Configuration:
        name: 'Configuration'
    LoadScreen:
        name: 'LoadScreen'


<Accueil>:
    MDScreen:
        md_bg_color: app.theme_cls.bg_light
        MDTopAppBar:
            title: "Accueil - APAB"
            pos_hint: { "top": 1 }
            right_action_items: [["delete", lambda x: app.reset_callback()]]
        RelativeLayout:
            MDFillRoundFlatIconButton:
                icon: "lan-connect"
                font_size: "24sp"
                text: 'Audit & Pentest'
                pos: 124,180
                on_release:
                    app.root.current = 'Option'
            MDFillRoundFlatIconButton:
                icon: "folder"
                font_size: "24sp"
                text: 'Rapports'
                pos: 157.5,130
                on_release:
                    app.file_manager_open()
            MDFillRoundFlatIconButton:
                elevation_normal: 12
                icon: "ip"
                font_size: "24sp"
                text: 'Configuration'
                pos: 135,80
                on_release:
                    app.root.current = 'Configuration'
            

<PentestScreen>:
    BoxLayout:
        orientation: "vertical"
        MDTopAppBar:
            title: "Pentest - Tests"
            pos_hint: {"top": 1}
            elevation: 10
        ScrollView:
            MDBoxLayout:
                md_bg_color: app.theme_cls.bg_light
                orientation: "vertical"
                adaptive_height: True
                padding: dp(100)
                spacing: dp(75)
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Sélectionner tout :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: master
                        on_active: serveur_web.active, netbios.active, banner.active, entete_web.active, cve.active, ssh_bf.active, smb_scanner.active, dos.active, dhcp_starvation.active, wifi.active, mac_flooding.active, stp_attack.active, check_tls.active = [self.active]*13
                MDLabel:
                    text: "Test audit"
                    halign: "center"
                    pos_hint: {"center_x": .5}
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Serveur web :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: serveur_web
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Netbios :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: netbios
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Bannière de service :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: banner
                MDLabel:
                    text: "Test système"
                    halign: "center"
                    pos_hint: {"center_x": .5}
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Entête HTTP :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: entete_web
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Vulnérabilité versions :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: cve
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "SSH Bruteforce :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: ssh_bf
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Partage de fichier :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: smb_scanner
                MDGridLayout:
                    cols: 2
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Certificat TLS :"
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: check_tls
                MDLabel:
                    text: "Test réseau"
                    halign: "center"
                    pos_hint: {"center_x": .5}
                MDGridLayout:
                    cols: 3
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "DHCP Starvation :"
                    MDIconButton:
                        icon: "alert"
                        theme_text_color:"Custom"
                        text_color:1, 0, 0, 1
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: dhcp_starvation
                MDGridLayout:
                    cols: 3
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "WIFI :"
                    MDIconButton:
                        icon: "alert"
                        theme_text_color:"Custom"
                        text_color:1, 0, 0, 1
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: wifi
                MDGridLayout:
                    cols: 3
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "Mac Flooding :"
                    MDIconButton:
                        icon: "alert"
                        theme_text_color:"Custom"
                        text_color:1, 0, 0, 1
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: mac_flooding
                MDGridLayout:
                    cols: 3
                    height: 15
                    size_hint_y: None
                    MDLabel:
                        text: "STP Attaque :"
                    MDIconButton:
                        icon: "alert"
                        theme_text_color:"Custom"
                        text_color:1, 0, 0, 1
                    MDCheckbox:
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: stp_attack
                MDGridLayout:
                    cols: 2
                    height: 50
                    size_hint_y: None
                    MDIconButton:
                        icon: "alert"
                        theme_text_color:"Custom"
                        text_color:1, 0, 0, 1
                    MDLabel:
                        text: "Ces tests peuvent avoir un impact sur le réseau cible"
                MDBoxLayout:
                    orientation: 'vertical'
                    MDFillRoundFlatButton:
                        pos_hint: {'center_x': .5, 'center_y': .5}
                        text: 'Lancer le test'
                        font_size: "24sp"
                        on_release:
                            root.check_checkbox([serveur_web, netbios, banner, entete_web, cve, ssh_bf, smb_scanner, dhcp_starvation, wifi, check_tls, mac_flooding, stp_attack], ["serveur_web", "netbios", "banner", "entete_web", "cve", "ssh_bf", "smb_scanner", "dhcp_starvation", "wifi", "check_tls", "mac_flooding", "stp_attack"], root.file_name)
                            root.start_loading()
                MDBoxLayout:
                    orientation: 'vertical'
                    MDFillRoundFlatButton:
                        pos_hint: {'center_x': .5, 'center_y': .5}
                        text: 'Retour'
                        font_size: "24sp"
                        on_release:
                            app.root.current = 'Option'


<Option>:
    BoxLayout:
        orientation: "vertical"
        MDTopAppBar:
            title: "Pentest - Options"
            pos_hint: {"top": 1}
            elevation: 10
        ScrollView:
            MDBoxLayout:
                md_bg_color: app.theme_cls.bg_light
                orientation: "vertical"
                adaptive_height: True
                padding: dp(100)
                spacing: dp(80)
                MDBoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: "Nom de l’entreprise:"
                        required: True
                        id: nom_entreprise
                MDBoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: "Mail entreprise:"
                        id: mail_entreprise
                MDBoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'Niveau de diffusion:'
                        required: True
                        id: niveau_diffusion
                        on_focus: if self.focus: root.drop(self)
                MDBoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'IP réseau à pentester:'
                        id: ip
                        required: True
                        helper_text: "0.0.0.0 test du réseau du boitier"
                        helper_text_mode: "persistent"
                MDBoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'Masque de sous-réseau:'
                        helper_text: "Masque au format CIDR, vide si ip 0.0.0.0"
                        helper_text_mode: "persistent"
                        id: masque_sous_reseau
                MDBoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'Passerelle:'
                        helper_text: "Vide si ip 0.0.0.0"
                        helper_text_mode: "persistent"
                        id: gateway
                BoxLayout:
                    MDTextField:
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'IP exclu des tests:'
                        id: ip_ex
                        helper_text: "Ex: 192.168.0.1-10, 192.168.0.45, 192.168.0.56"
                        helper_text_mode: "persistent"
                MDBoxLayout:
                    orientation: 'vertical'
                    MDFillRoundFlatButton:
                        disabled: True if ip.text == '' or nom_entreprise.text == '' or niveau_diffusion.text == '' else False
                        pos_hint: {'center_x': .5, 'center_y': .5}
                        text: 'Suivant'
                        font_size: "24sp"
                        on_release:
                            root.save_options([nom_entreprise, mail_entreprise, niveau_diffusion, ip, masque_sous_reseau, gateway, ip_ex], ["nom_entreprise", "mail_entreprise", "niveau_diffusion", "ip", "masque_sous_reseau", "gateway", "ip_ex"])
                            app.root.current = 'PentestScreen'
                MDBoxLayout:
                    orientation: 'vertical'
                    MDFillRoundFlatButton:
                        pos_hint: {'center_x': .5, 'center_y': .5}
                        text: 'Retour'
                        font_size: "24sp"
                        on_release:
                            app.root.current = 'Accueil'

<Configuration>
    BoxLayout:
        orientation: "vertical"
        MDTopAppBar:
            title: "Configuration"
            pos_hint: {"top": 1}
            elevation: 10
        ScrollView:
            MDBoxLayout:
                md_bg_color: app.theme_cls.bg_light
                orientation: "vertical"
                adaptive_height: True
                padding: dp(100)
                spacing: dp(75)
                MDGridLayout:
                    cols: 2
                    height: 50
                    MDLabel:
                        font_size: "18sp"
                        text: "IP actuelle"
                    MDLabel:
                        font_size: "18sp"
                        text: root.ip
                MDGridLayout:
                    cols: 2
                    height: 50
                    size_hint_y: None
                    MDLabel:
                        text: "DHCP :"
                    MDSwitch:
                        active: True
                        size_hint: None, None
                        color_active: "white"
                        size: "48dp", "48dp"
                        id: dhcp_configuration
                        on_active: root.toggle_visibility(self, self.active)
                MDBoxLayout:
                    MDTextField:
                        opacity: 0
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'IP :'
                        id: ip_configuration
                        helper_text: "Ip du boitier de pentest"
                        helper_text_mode: "persistent"
                MDBoxLayout:
                    MDTextField:
                        opacity: 0
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'Masque de sous-réseau:'
                        helper_text: "Masque au format CIDR"
                        helper_text_mode: "persistent"
                        id: masque_sous_reseau_configuration
                MDBoxLayout:
                    MDTextField:
                        opacity: 0
                        font_size: "18sp"
                        line_color_normal: 1,1,1
                        hint_text_color_normal: 1,1,1
                        hint_text: 'Passerelle:'
                        id: gateway_configuration
                MDBoxLayout:
                    orientation: 'vertical'
                    MDFillRoundFlatButton:
                        pos_hint: {'center_x': .5, 'center_y': .5}
                        text: 'Sauvegarder'
                        font_size: "24sp"
                        on_release:
                            root.save_configuration([dhcp_configuration, ip_configuration, masque_sous_reseau_configuration, gateway_configuration], ["dhcp", "ip", "masque_sous_reseau", "gateway"])
                            app.root.current = 'Accueil'
                MDBoxLayout:
                    orientation: 'vertical'
                    MDFillRoundFlatButton:
                        pos_hint: {'center_x': .5, 'center_y': .5}
                        text: 'Retour'
                        font_size: "24sp"
                        on_release:
                            app.root.current = 'Accueil'


<LoadScreen>:
    MDScreen:
        MDBoxLayout:
            md_bg_color: app.theme_cls.bg_light
            orientation: "vertical"
            padding: dp(100)
            MDLabel:
                text: 'Test(s) en cours...'
                halign: 'center'
            MDProgressBar:
                id: progress_bar
                type: "determinate"
                running_duration: 2
                pos_hint: {"center_y": .5}
                size_hint_y: None
                color: 0,0,1,1

